<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ЕГЭ Химия — Номенклатура неорганики (выбор)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px; line-height: 1.4; }
    a { color: inherit; }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 14px; }
    .pill { border:1px solid #e5e5e5; border-radius:999px; padding: 6px 10px; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; max-width: 980px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted { color:#666; }
    .small { font-size: 13px; }
    .grid2 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 900px) { .grid2 { grid-template-columns: 1.1fr 0.9fr; } }
    textarea { width:100%; min-height: 170px; padding: 10px 12px; border-radius: 10px; border:1px solid #ccc; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }

    .answers { display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 12px; }
    @media (min-width: 700px) { .answers { grid-template-columns: 1fr 1fr; } }

    .btn {
      text-align:left;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover { background:#f0f0f0; }
    .btn:disabled { cursor: default; opacity: 0.9; }
    .btn.correct { border-color:#0b6; background: #f3fff8; }
    .btn.wrong { border-color:#c00; background: #fff4f4; }

    .ok { color:#0b6; font-weight:600; }
    .bad { color:#c00; font-weight:600; }

    .controls button {
      padding: 10px 12px; border-radius: 10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer;
    }
    .controls button:hover { background:#f0f0f0; }
  </style>
</head>
<body>

<div class="topbar">
  <a href="index.html">← На главную</a>
  <span class="pill">Номенклатура неорганики</span>
  <span class="pill">Режим: кнопки-ответы</span>
</div>

<div class="grid2">
  <div class="card">
    <h1 style="margin:0 0 6px 0;">Тренажёр</h1>
    <div class="muted" style="margin-bottom:10px;">
      Выберите правильное название для формулы. После выбора — переход к следующему автоматически.
    </div>

    <div class="row" style="margin: 10px 0;">
      <span class="pill">Вопрос: <span id="qIndex">1</span>/<span id="qTotal">0</span></span>
      <span class="pill">Верно: <span id="okCount">0</span></span>
      <span class="pill">Ошибок: <span id="badCount">0</span></span>
      <span class="pill">Точность: <span id="score">0</span>%</span>
    </div>

    <h2 id="question" style="margin: 10px 0 6px 0; font-size: 26px;">—</h2>
    <div class="muted small" id="tip">Подсказка появится после ответа.</div>

    <div class="answers" id="answers"></div>

    <div id="feedback" style="margin-top: 12px;"></div>

    <hr style="border:none; border-top:1px solid #eee; margin: 14px 0;">

    <div class="row controls">
      <button id="restartBtn">Сначала</button>
      <button id="repeatWrongBtn" title="Пройти второй круг только по ошибкам">Повторить ошибки</button>
      <label class="pill" style="user-select:none;">
        <input type="checkbox" id="shuffle" checked>
        Перемешать вопросы
      </label>
      <label class="pill" style="user-select:none;">
        <input type="checkbox" id="mixAnswers" checked>
        Перемешать варианты ответа
      </label>
      <label class="pill" style="user-select:none;">
        Вариантов:
        <select id="choicesCount">
          <option value="4" selected>4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </label>
    </div>

    <p class="muted small" style="margin-top:10px;">
      Плюс этого режима: ученик не “тонет” в синонимах вроде «натрий сернокислый».
      Минус: отвлекающие ответы должны быть качественными — их как раз и сделаем следующей доработкой.
    </p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px 0;">Результаты и экспорт</h2>
    <p class="muted small" style="margin-top:0;">
      CSV: формула; выбранный ответ; правильный ответ; верно(1/0)
    </p>

    <div class="row" style="margin: 10px 0;">
      <button id="downloadBtn">Скачать CSV</button>
      <button id="copyBtn">Скопировать CSV</button>
      <button id="clearBtn">Очистить результаты</button>
    </div>

    <textarea id="log" readonly placeholder="Здесь появятся результаты…"></textarea>
  </div>
</div>

<script>
/** ===== База: формула -> эталонное название =====
 * Можно добавлять сколько угодно. Эталон — первый вариант.
 */
const TASKS = [
  { f:"CO",    right:"оксид углерода(ii)", tip:"C(+2) — CO." },
  { f:"CO2",   right:"оксид углерода(iv)", tip:"C(+4) — CO₂." },
  { f:"SO2",   right:"оксид серы(iv)", tip:"S(+4)." },
  { f:"SO3",   right:"оксид серы(vi)", tip:"S(+6)." },
  { f:"P2O5",  right:"оксид фосфора(v)", tip:"P(+5)." },
  { f:"N2O5",  right:"оксид азота(v)", tip:"N(+5)." },
  { f:"FeO",   right:"оксид железа(ii)", tip:"Fe(+2)." },
  { f:"Fe2O3", right:"оксид железа(iii)", tip:"Fe(+3)." },
  { f:"Cu2O",  right:"оксид меди(i)", tip:"Cu(+1)." },
  { f:"CuO",   right:"оксид меди(ii)", tip:"Cu(+2)." },

  { f:"HCl",   right:"соляная кислота", tip:"HCl(р-р) — соляная." },
  { f:"H2S",   right:"сероводородная кислота", tip:"Слабая кислота." },
  { f:"H2SO4", right:"серная кислота", tip:"Сильная двухосновная." },
  { f:"H2SO3", right:"сернистая кислота", tip:"Соответствует SO₂." },
  { f:"HNO3",  right:"азотная кислота", tip:"Сильная одноосновная." },
  { f:"H3PO4", right:"ортофосфорная кислота", tip:"Трёхосновная." },
  { f:"H2CO3", right:"угольная кислота", tip:"Нестойкая." },

  { f:"NaOH",  right:"гидроксид натрия", tip:"Щёлочь." },
  { f:"KOH",   right:"гидроксид калия", tip:"Щёлочь." },
  { f:"Ca(OH)2", right:"гидроксид кальция", tip:"Малорастворимая щёлочь." },
  { f:"Al(OH)3", right:"гидроксид алюминия", tip:"Амфотерный." },
  { f:"Zn(OH)2", right:"гидроксид цинка", tip:"Амфотерный." },

  { f:"NaCl",  right:"хлорид натрия", tip:"Средняя соль." },
  { f:"K2SO4", right:"сульфат калия", tip:"Соль серной кислоты." },
  { f:"Na2SO3", right:"сульфит натрия", tip:"Соль сернистой кислоты." },
  { f:"CaCO3", right:"карбонат кальция", tip:"Соль угольной кислоты." },
  { f:"Na2CO3", right:"карбонат натрия", tip:"Кальцинированная сода." },
  { f:"NaHCO3", right:"гидрокарбонат натрия", tip:"Кислая соль." },
  { f:"KNO3",  right:"нитрат калия", tip:"Соль азотной кислоты." },
  { f:"CuSO4", right:"сульфат меди(ii)", tip:"Cu(+2)." },
  { f:"FeCl3", right:"хлорид железа(iii)", tip:"Fe(+3)." },
  { f:"FeSO4", right:"сульфат железа(ii)", tip:"Fe(+2)." }
];

/** ====== Утилиты ====== */
function norm(s){
  return (s||"").toLowerCase().replace(/ё/g,"е").replace(/\s+/g," ").trim();
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function csvCell(s){
  const t = (s || "").replace(/"/g, '""');
  if(/[;\n\r"]/.test(t)) return `"${t}"`;
  return t;
}

/** ====== Состояние ====== */
let items = [];
let idx = 0;
let ok = 0;
let bad = 0;
let results = [];
let wrongPool = []; // для повторения ошибок
let locked = false;

const elQIndex = document.getElementById("qIndex");
const elQTotal = document.getElementById("qTotal");
const elOk = document.getElementById("okCount");
const elBad = document.getElementById("badCount");
const elScore = document.getElementById("score");
const elQuestion = document.getElementById("question");
const elTip = document.getElementById("tip");
const elAnswers = document.getElementById("answers");
const elFeedback = document.getElementById("feedback");
const elLog = document.getElementById("log");

const elShuffle = document.getElementById("shuffle");
const elMixAnswers = document.getElementById("mixAnswers");
const elChoicesCount = document.getElementById("choicesCount");

document.getElementById("restartBtn").addEventListener("click", () => start("all"));
document.getElementById("repeatWrongBtn").addEventListener("click", () => start("wrong"));
document.getElementById("downloadBtn").addEventListener("click", downloadCSV);
document.getElementById("copyBtn").addEventListener("click", copyCSV);
document.getElementById("clearBtn").addEventListener("click", clearAll);

function start(mode){
  locked = false;
  idx = 0; ok = 0; bad = 0;
  results = [];
  wrongPool = [];

  if(mode === "wrong"){
    // если ошибок нет — смысла нет
    const prevWrong = loadLastWrong();
    if(!prevWrong.length){
      elFeedback.innerHTML = `<div class="bad">Нет сохранённых ошибок для повтора.</div>`;
      items = TASKS.slice();
    } else {
      items = prevWrong.map(x => ({...x}));
      elFeedback.innerHTML = `<div class="ok">Повторяем только ошибки: ${items.length}.</div>`;
    }
  } else {
    items = TASKS.slice();
  }

  if(elShuffle.checked) shuffle(items);
  render();
  renderLog();
}

function render(){
  elQTotal.textContent = String(items.length);
  elQIndex.textContent = String(Math.min(idx+1, items.length));
  elOk.textContent = String(ok);
  elBad.textContent = String(bad);
  const done = ok + bad;
  elScore.textContent = String(done ? Math.round((ok/done)*100) : 0);

  elFeedback.innerHTML = "";
  elTip.textContent = "Подсказка появится после ответа.";
  elAnswers.innerHTML = "";

  if(idx >= items.length){
    elQuestion.textContent = "Готово. Тренировка завершена.";
    elTip.textContent = "Можно скачать CSV справа или повторить ошибки.";
    saveLastWrong(wrongPool);
    return;
  }

  const cur = items[idx];
  elQuestion.textContent = `Выберите название: ${cur.f}`;

  const choiceCount = Number(elChoicesCount.value);
  const options = buildOptions(cur, choiceCount);
  if(elMixAnswers.checked) shuffle(options);

  for(const opt of options){
    const b = document.createElement("button");
    b.className = "btn";
    b.textContent = opt;
    b.addEventListener("click", () => pickAnswer(opt));
    elAnswers.appendChild(b);
  }
}

function buildOptions(cur, count){
  const correct = cur.right;
  const pool = TASKS
    .map(t => t.right)
    .filter(name => norm(name) !== norm(correct));

  // Берём случайные отвлекающие
  shuffle(pool);
  const distractors = pool.slice(0, Math.max(0, count - 1));
  const options = [correct, ...distractors];

  // Если вдруг задач мало — подстрахуемся
  while(options.length < count){
    options.push("—");
  }
  return options;
}

function pickAnswer(selected){
  if(locked) return;
  locked = true;

  const cur = items[idx];
  const isCorrect = norm(selected) === norm(cur.right);

  // Подсветка кнопок
  const btns = [...elAnswers.querySelectorAll("button")];
  for(const b of btns){
    const t = norm(b.textContent);
    if(t === norm(cur.right)) b.classList.add("correct");
    if(t === norm(selected) && !isCorrect) b.classList.add("wrong");
    b.disabled = true;
  }

  if(isCorrect){
    ok++;
    elFeedback.innerHTML = `<div class="ok">Верно.</div>`;
  } else {
    bad++;
    elFeedback.innerHTML = `<div class="bad">Неверно.</div>
      <div class="small muted">Правильный ответ: <b>${cur.right}</b></div>`;
    wrongPool.push(cur);
  }

  elTip.textContent = cur.tip || "—";

  results.push({ formula: cur.f, chosen: selected, right: cur.right, isCorrect });

  idx++;
  renderLog();

  setTimeout(() => {
    locked = false;
    render();
  }, 700);
}

/** ===== Лог и экспорт ===== */
function renderLog(){
  const lines = [];
  lines.push("Формула;Выбранный ответ;Правильный ответ;Верно");
  for(const r of results){
    lines.push(`${r.formula};${csvCell(r.chosen)};${csvCell(r.right)};${r.isCorrect ? "1" : "0"}`);
  }
  elLog.value = lines.join("\n");
}

function downloadCSV(){
  const blob = new Blob([elLog.value], {type: "text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "inorg_nomenclature_results.csv";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function copyCSV(){
  try{
    await navigator.clipboard.writeText(elLog.value);
    elFeedback.innerHTML = `<div class="ok">CSV скопирован в буфер обмена.</div>`;
  } catch(e){
    elFeedback.innerHTML = `<div class="bad">Не удалось скопировать. Скопируйте вручную из поля справа.</div>`;
  }
}

function clearAll(){
  results = [];
  wrongPool = [];
  ok = 0; bad = 0; idx = 0;
  elLog.value = "";
  elFeedback.innerHTML = `<div class="ok">Результаты очищены.</div>`;
  saveLastWrong([]);
  render();
}

/** ===== Повтор ошибок (сохраняем в LocalStorage) ===== */
const WRONG_KEY = "chem_inorg_nomen_wrong_v1";

function saveLastWrong(arr){
  try{
    const safe = (arr || []).map(x => ({ f:x.f, right:x.right, tip:x.tip }));
    localStorage.setItem(WRONG_KEY, JSON.stringify(safe));
  } catch(e){}
}
function loadLastWrong(){
  try{
    const raw = localStorage.getItem(WRONG_KEY);
    if(!raw) return [];
    return JSON.parse(raw) || [];
  } catch(e){
    return [];
  }
}

/** Старт */
start("all");
</script>

</body>
</html>
