<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ЕГЭ Химия — Номенклатура неорганики</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px; line-height: 1.4; }
    a { color: inherit; }
    .topbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom: 14px; }
    .pill { border:1px solid #e5e5e5; border-radius:999px; padding: 6px 10px; user-select:none; }
    .card { border: 1px solid #e5e5e5; border-radius: 12px; padding: 14px; max-width: 1100px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .muted { color:#666; }
    .small { font-size: 13px; }

    .grid2 { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 1000px) { .grid2 { grid-template-columns: 1.2fr 0.8fr; } }

    .answers { display:grid; grid-template-columns: 1fr; gap:10px; margin-top: 12px; }
    @media (min-width: 760px) { .answers { grid-template-columns: 1fr 1fr; } }

    .btn {
      text-align:left;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 16px;
    }
    .btn:hover { background:#f0f0f0; }
    .btn:disabled { cursor: default; opacity: 0.92; }

    .btn.selected { border-color:#2563eb; background:#eff6ff; }
    .btn.correct  { border-color:#16a34a; background:#f0fdf4; }
    .btn.wrong    { border-color:#dc2626; background:#fef2f2; }

    .ok { color:#16a34a; font-weight:600; }
    .bad { color:#dc2626; font-weight:600; }

    .primary {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #111;
      background:#111;
      color:#fff;
      cursor:pointer;
      font-size: 15px;
    }
    .primary:hover { background:#000; }
    .primary:disabled { opacity: 0.6; cursor: default; }

    .secondary {
      padding: 10px 12px;
      border-radius: 10px;
      border:1px solid #ccc;
      background:#f7f7f7;
      cursor:pointer;
    }
    .secondary:hover { background:#f0f0f0; }

    select { padding: 6px 8px; border-radius: 10px; border:1px solid #ccc; }

    /* Навигация по вопросам */
    .nav {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top: 10px.0;
    }
    .qbtn {
      width: 38px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 13px;
      line-height: 34px;
      text-align:center;
      user-select:none;
    }
    .qbtn:hover { background:#f0f0f0; }
    .qbtn.current { border-color:#111; box-shadow: 0 0 0 2px rgba(0,0,0,0.08) inset; }
    .qbtn.unanswered { background:#f7f7f7; }
    .qbtn.right { background:#f0fdf4; border-color:#16a34a; }
    .qbtn.wrong { background:#fef2f2; border-color:#dc2626; }
  </style>
</head>
<body>

<div class="topbar">
  <a href="index.html">← На главную</a>
  <span class="pill">Номенклатура неорганики</span>
  <span class="pill">Выбор → Ответить → Далее</span>
</div>

<div class="grid2">
  <div class="card">
    <h1 style="margin:0 0 6px 0;">Тренажёр</h1>
    <div class="muted" style="margin-bottom:10px;">
      Выберите вариант. Пока не нажали «Ответить», можно изменить выбор.
    </div>

    <div class="row" style="margin: 10px 0;">
      <span class="pill">Вопрос: <span id="qIndex">1</span>/<span id="qTotal">0</span></span>
      <span class="pill">Верно: <span id="okCount">0</span></span>
      <span class="pill">Ошибок: <span id="badCount">0</span></span>
      <span class="pill">Точность: <span id="score">0</span>%</span>
    </div>

    <h2 id="question" style="margin: 10px 0 6px 0; font-size: 26px;">—</h2>
    <div class="muted small" id="tip">Подсказка появится после проверки.</div>

    <div class="answers" id="answers"></div>

    <div class="row" style="margin-top: 12px;">
      <button id="actionBtn" class="primary" disabled>Ответить</button>
      <button id="prevBtn" class="secondary" title="Назад к предыдущему вопросу">Назад</button>
      <button id="nextBtn" class="secondary" title="Вперёд к следующему вопросу">Вперёд</button>
      <span class="muted small" id="statusText">Выберите вариант ответа.</span>
    </div>

    <div id="feedback" style="margin-top: 12px;"></div>

    <hr style="border:none; border-top:1px solid #eee; margin: 14px 0;">

    <h3 style="margin: 0 0 8px 0;">Настройки</h3>
    <div class="row">
      <label class="pill">
        <input type="checkbox" id="shuffle" checked />
        Перемешать вопросы
      </label>

      <label class="pill">
        <input type="checkbox" id="mixAnswers" checked />
        Перемешать варианты
      </label>

      <label class="pill">
        Вариантов:
        <select id="choicesCount">
          <option value="4" selected>4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <label class="pill">
        <input type="checkbox" id="autoNextCorrect">
        Автопереход, если ответ правильный
      </label>

      <label class="pill">
        <input type="checkbox" id="autoNextWrong">
        Автопереход, если ответ неправильный
      </label>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="restartBtn" class="secondary">Сначала</button>
      <button id="repeatWrongBtn" class="secondary" title="Пройти второй круг только по ошибкам">Повторить ошибки</button>
    </div>

    <p class="muted small" style="margin-top:10px;">
      Подсветка номеров вопросов: серый — не отвечено, зелёный — правильно, красный — неправильно.
    </p>
  </div>

  <div class="card">
    <h2 style="margin:0 0 6px 0;">Навигация по вопросам</h2>
    <p class="muted small" style="margin-top:0;">
      Можно прыгать на любой вопрос. Цвет показывает, какой ответ был сохранён после нажатия «Ответить».
    </p>
    <div id="nav" class="nav"></div>
  </div>
</div>

<script>
/** ===== Банк (32 вопроса) =====
 * f — формула, right — эталонный ответ (для кнопочного режима),
 * tip — краткая подсказка после проверки.
 */
const TASKS = [
  // Оксиды (10)
  { f:"CO",    right:"оксид углерода(ii)",  tip:"C(+2)." },
  { f:"CO2",   right:"оксид углерода(iv)",  tip:"C(+4)." },
  { f:"SO2",   right:"оксид серы(iv)",      tip:"S(+4)." },
  { f:"SO3",   right:"оксид серы(vi)",      tip:"S(+6)." },
  { f:"P2O5",  right:"оксид фосфора(v)",    tip:"P(+5)." },
  { f:"N2O5",  right:"оксид азота(v)",      tip:"N(+5)." },
  { f:"FeO",   right:"оксид железа(ii)",    tip:"Fe(+2)." },
  { f:"Fe2O3", right:"оксид железа(iii)",   tip:"Fe(+3)." },
  { f:"Cu2O",  right:"оксид меди(i)",       tip:"Cu(+1)." },
  { f:"CuO",   right:"оксид меди(ii)",      tip:"Cu(+2)." },

  // Кислоты (8)
  { f:"HCl",    right:"соляная кислота",            tip:"HCl(р-р)." },
  { f:"H2S",    right:"сероводородная кислота",     tip:"Слабая." },
  { f:"H2SO4",  right:"серная кислота",             tip:"Сильная, 2-осн." },
  { f:"H2SO3",  right:"сернистая кислота",          tip:"Соответствует SO2." },
  { f:"HNO3",   right:"азотная кислота",            tip:"Сильная." },
  { f:"HNO2",   right:"азотистая кислота",          tip:"Слабее HNO3." },
  { f:"H3PO4",  right:"ортофосфорная кислота",      tip:"3-осн." },
  { f:"H2CO3",  right:"угольная кислота",           tip:"Нестойкая." },

  // Основания/амфотерные (7)
  { f:"NaOH",     right:"гидроксид натрия",         tip:"Щёлочь." },
  { f:"KOH",      right:"гидроксид калия",          tip:"Щёлочь." },
  { f:"Ca(OH)2",  right:"гидроксид кальция",        tip:"Малораств. щёлочь." },
  { f:"Ba(OH)2",  right:"гидроксид бария",          tip:"Щёлочь." },
  { f:"Al(OH)3",  right:"гидроксид алюминия",       tip:"Амфотерный." },
  { f:"Zn(OH)2",  right:"гидроксид цинка",          tip:"Амфотерный." },
  { f:"Fe(OH)3",  right:"гидроксид железа(iii)",    tip:"Fe(+3)." },

  // Соли (7)
  { f:"NaCl",     right:"хлорид натрия",            tip:"Средняя соль." },
  { f:"K2SO4",    right:"сульфат калия",            tip:"Соль H2SO4." },
  { f:"Na2SO3",   right:"сульфит натрия",           tip:"Соль H2SO3." },
  { f:"CaCO3",    right:"карбонат кальция",         tip:"Соль H2CO3." },
  { f:"Na2CO3",   right:"карбонат натрия",          tip:"Кальцинированная сода." },
  { f:"NaHCO3",   right:"гидрокарбонат натрия",     tip:"Кислая соль." },
  { f:"KNO3",     right:"нитрат калия",             tip:"Соль HNO3." }
];

/** ===== Утилиты ===== */
function norm(s){ return (s||"").toLowerCase().replace(/ё/g,"е").replace(/\s+/g," ").trim(); }
function shuffleArray(arr){
  for(let i = arr.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

/** ===== DOM ===== */
const elQIndex = document.getElementById("qIndex");
const elQTotal = document.getElementById("qTotal");
const elOk = document.getElementById("okCount");
const elBad = document.getElementById("badCount");
const elScore = document.getElementById("score");
const elQuestion = document.getElementById("question");
const elTip = document.getElementById("tip");
const elAnswers = document.getElementById("answers");
const elFeedback = document.getElementById("feedback");
const elActionBtn = document.getElementById("actionBtn");
const elStatusText = document.getElementById("statusText");
const elNav = document.getElementById("nav");

const elShuffle = document.getElementById("shuffle");
const elMixAnswers = document.getElementById("mixAnswers");
const elChoicesCount = document.getElementById("choicesCount");
const elAutoNextCorrect = document.getElementById("autoNextCorrect");
const elAutoNextWrong = document.getElementById("autoNextWrong");

document.getElementById("restartBtn").addEventListener("click", () => start("all"));
document.getElementById("repeatWrongBtn").addEventListener("click", () => start("wrong"));
document.getElementById("prevBtn").addEventListener("click", () => goTo(idx - 1));
document.getElementById("nextBtn").addEventListener("click", () => goTo(idx + 1));

/** ===== Состояние ===== */
let items = [];
let idx = 0;
let ok = 0;
let bad = 0;

// answersState[index] = { chosen: string|null, isCorrect: boolean|null, locked: boolean }
let answersState = [];

// текущий выбор до фиксации
let selectedAnswer = null;

// choose | checked | finished
let phase = "choose";

// пул неправильных (для повтора)
let wrongPool = [];

// чтобы не было гонок при автопереходе
let autoTimer = null;

/** ===== Старт/перезапуск ===== */
function start(mode){
  clearAuto();

  // собираем items
  if(mode === "wrong"){
    const prevWrong = loadLastWrong();
    if(prevWrong.length){
      items = prevWrong.map(x => ({...x}));
    } else {
      items = TASKS.slice();
      // пусть пользователь не остается в пустоте
      elFeedback.innerHTML = `<div class="bad">Нет сохранённых ошибок для повтора — запускаю полный набор.</div>`;
    }
  } else {
    items = TASKS.slice();
  }

  if(elShuffle.checked) shuffleArray(items);

  idx = 0;
  ok = 0;
  bad = 0;
  wrongPool = [];

  answersState = items.map(_ => ({ chosen:null, isCorrect:null, locked:false }));

  buildNav();
  render();
}

function clearAuto(){
  if(autoTimer){
    clearTimeout(autoTimer);
    autoTimer = null;
  }
}

/** ===== Навигация по номерам ===== */
function buildNav(){
  elNav.innerHTML = "";
  for(let i=0; i<items.length; i++){
    const b = document.createElement("button");
    b.className = "qbtn unanswered";
    b.textContent = String(i+1);
    b.addEventListener("click", () => goTo(i));
    elNav.appendChild(b);
  }
  paintNav();
}

function paintNav(){
  const btns = [...elNav.querySelectorAll("button")];
  for(let i=0;i<btns.length;i++){
    const st = answersState[i];
    btns[i].classList.remove("current","unanswered","right","wrong");
    if(i === idx) btns[i].classList.add("current");

    if(st.isCorrect === true) btns[i].classList.add("right");
    else if(st.isCorrect === false) btns[i].classList.add("wrong");
    else btns[i].classList.add("unanswered");
  }
}

function goTo(i){
  clearAuto();
  if(i < 0 || i >= items.length) return;
  idx = i;
  render();
}

/** ===== Рендер ===== */
function updateStats(){
  elQTotal.textContent = String(items.length);
  elQIndex.textContent = String(Math.min(idx+1, items.length));
  elOk.textContent = String(ok);
  elBad.textContent = String(bad);
  const done = ok + bad;
  elScore.textContent = String(done ? Math.round((ok/done)*100) : 0);
}

function render(){
  updateStats();
  paintNav();

  elAnswers.innerHTML = "";
  elFeedback.innerHTML = "";
  elTip.textContent = "Подсказка появится после проверки.";
  selectedAnswer = null;
  phase = "choose";

  if(idx >= items.length){
    phase = "finished";
    elQuestion.textContent = "Готово. Тренировка завершена.";
    elStatusText.textContent = "Можно повторить ошибки или начать сначала.";
    elActionBtn.textContent = "Готово";
    elActionBtn.disabled = true;
    saveLastWrong(wrongPool);
    return;
  }

  const st = answersState[idx];
  const cur = items[idx];

  elQuestion.textContent = `Выберите название: ${cur.f}`;

  // строим варианты
  let options = buildOptions(cur, Number(elChoicesCount.value));
  if(elMixAnswers.checked) shuffleArray(options);

  // рисуем кнопки
  for(const opt of options){
    const b = document.createElement("button");
    b.className = "btn";
    b.type = "button";
    b.textContent = opt;
    b.addEventListener("click", () => selectOption(opt, b));
    elAnswers.appendChild(b);
  }

  // если вопрос уже был отвечен — показываем сохранённый результат и блокируем варианты
  if(st.locked){
    phase = "checked";
    elActionBtn.textContent = "Далее";
    elActionBtn.disabled = false;
    elStatusText.textContent = "Ответ уже сохранён. Можно перейти далее.";
    showSavedState(cur, st);
  } else {
    elActionBtn.textContent = "Ответить";
    elActionBtn.disabled = true;
    elStatusText.textContent = "Выберите вариант ответа.";
  }
}

function buildOptions(cur, count){
  const correct = cur.right;
  const pool = items
    .map(t => t.right)
    .filter(name => norm(name) !== norm(correct));

  shuffleArray(pool);
  const distractors = pool.slice(0, Math.max(0, count - 1));
  const opts = [correct, ...distractors];
  while(opts.length < count) opts.push("—");
  return opts;
}

function selectOption(opt, btnEl){
  if(phase !== "choose") return;

  selectedAnswer = opt;

  for(const b of elAnswers.querySelectorAll("button")){
    b.classList.remove("selected");
  }
  btnEl.classList.add("selected");

  elActionBtn.disabled = false;
  elStatusText.textContent = "Нажмите «Ответить», чтобы зафиксировать выбор.";
}

elActionBtn.addEventListener("click", () => {
  if(phase === "choose") submit();
  else if(phase === "checked") goTo(idx + 1);
});

function submit(){
  if(phase !== "choose") return;
  if(!selectedAnswer) return;

  const cur = items[idx];
  const isCorrect = norm(selectedAnswer) === norm(cur.right);

  // сохраняем состояние вопроса
  const st = answersState[idx];
  st.chosen = selectedAnswer;
  st.isCorrect = isCorrect;
  st.locked = true;

  // обновляем общую статистику (важно: считать только впервые)
  if(isCorrect) ok++; else bad++;

  if(!isCorrect) wrongPool.push(cur);

  phase = "checked";
  elActionBtn.textContent = "Далее";
  elActionBtn.disabled = false;
  elStatusText.textContent = "Можно перейти к следующему вопросу.";

  // подсветка и блокировка вариантов
  lockAndPaint(cur, st);

  // подсказка
  elTip.textContent = cur.tip || "—";

  // сообщение
  if(isCorrect){
    elFeedback.innerHTML = `<div class="ok">Верно.</div>`;
  } else {
    elFeedback.innerHTML = `<div class="bad">Неверно.</div><div class="small muted">Правильный ответ: <b>${cur.right}</b></div>`;
  }

  updateStats();
  paintNav();

  // автопереход по настройкам
  const shouldAuto =
    (isCorrect && elAutoNextCorrect.checked) ||
    (!isCorrect && elAutoNextWrong.checked);

  if(shouldAuto){
    elStatusText.textContent = "Автопереход включён — переходим…";
    elActionBtn.disabled = true;
    clearAuto();
    autoTimer = setTimeout(() => {
      autoTimer = null;
      goTo(idx + 1);
    }, 700);
  }
}

function lockAndPaint(cur, st){
  const btns = [...elAnswers.querySelectorAll("button")];
  for(const b of btns){
    const t = norm(b.textContent);
    if(t === norm(cur.right)) b.classList.add("correct");
    if(st.chosen && t === norm(st.chosen) && st.isCorrect === false) b.classList.add("wrong");
    if(st.chosen && t === norm(st.chosen)) b.classList.add("selected");
    b.disabled = true;
  }
}

function showSavedState(cur, st){
  // подсказка
  elTip.textContent = cur.tip || "—";

  // подсветка + блокировка
  lockAndPaint(cur, st);

  // фидбек
  if(st.isCorrect === true){
    elFeedback.innerHTML = `<div class="ok">Верно (сохранено).</div>`;
  } else if(st.isCorrect === false){
    elFeedback.innerHTML = `<div class="bad">Неверно (сохранено).</div><div class="small muted">Правильный ответ: <b>${cur.right}</b></div>`;
  }
}

/** ===== Повтор ошибок (LocalStorage) ===== */
const WRONG_KEY = "chem_inorg_nomen_wrong_v3";

function saveLastWrong(arr){
  try{
    const safe = (arr || []).map(x => ({ f:x.f, right:x.right, tip:x.tip }));
    localStorage.setItem(WRONG_KEY, JSON.stringify(safe));
  } catch(e){}
}
function loadLastWrong(){
  try{
    const raw = localStorage.getItem(WRONG_KEY);
    if(!raw) return [];
    return JSON.parse(raw) || [];
  } catch(e){
    return [];
  }
}

/** Старт */
start("all");
</script>

</body>
</html>
